<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Poem Manager</title>
	<style>
		:root{
			--bg:#111; /* page background */
			--card:#1b1b1b; /* panels */
			--well:#262626; /* inputs */
			--ring:#333; /* borders */
			--text:#fff;
			--muted:#bcbccf;
			--btn:#333; /* button normal */
			--btn-hover:#444; /* button hover */
			--accent:#6a5acd; /* subtle accent */
		}

		*,
		*:before,
		*:after { box-sizing: border-box; }

		html, body { height: 100%; }

		body{
			margin:0;
			padding:24px 16px 32px;
			background:var(--bg);
			color:var(--text);
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
			line-height:1.4;
		}

		/* Center content and keep it comfortably wide on phones */
		.wrap{
			max-width: 720px;
			margin: 0 auto;
		}

		/* Title */
		h1{
			font-size: 32px;
			margin: 6px 0 18px;
			text-align: center;
		}

		/* Sections become dark ‚Äúcards‚Äù */
		.section{
			background: var(--card);
			border: 1px solid var(--ring);
			border-radius: 16px;
			padding: 16px;
			margin: 16px 0;
			box-shadow: 0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
		}

		.section h2{
			margin: 0 0 10px;
			font-size: 18px;
		}

		/* Inputs look like wells; size >=16px to stop iOS auto-zoom */
		input, textarea{
			width:100%;
			padding:12px 12px;
			margin:8px 0 12px;
			background: var(--well);
			color: var(--text);
			border: 1px solid var(--ring);
			border-radius: 10px;
			outline: none;
			font-size: 18px; /* prevents Safari zoom while typing */
		}

		/* The little ‚ÄúFavorite / Remove‚Äù submit buttons */
		.small-button{
			background: var(--btn);
			color: var(--text);
			border: 1px solid var(--ring);
			border-radius: 12px;
			padding: 8px 12px;
			font-size: 16px;
			cursor: pointer;
		}
		.small-button:hover{ background: var(--btn-hover); }

		/* Primary action buttons */
		button[type="submit"]{
			background: var(--btn);
			color: var(--text);
			border: 1px solid var(--ring);
			border-radius: 12px;
			padding: 10px 14px;
			font-size: 18px; /* also ‚â•16px */
			cursor: pointer;
		}
		button[type="submit"]:hover{ background: var(--btn-hover); }

		/* Current poem area */
		#current-poem{
			white-space: pre-wrap;
			border: 1px solid var(--ring);
			border-radius: 12px;
			padding: 12px;
			background: var(--well);
			color: var(--text);
			min-height: 80px;
		}

		/* Tiny subtle labels / footnotes */
		.muted{ color: var(--muted); font-size: 14px; }
	</style>
</head>
<body>
	<div class="wrap">
		<h1 style="text-align: center;">ü™û Poem Manager</h1>

		<div class="section">
			<h2>‚ûï Add a New Poem</h2>
			<form id="addForm" method="POST">
				<textarea name="poem_text" rows="4" placeholder="Write a new poem‚Ä¶" required></textarea>
				<br>
				<input type="text" name="author" placeholder="Author (optional)">
				<label style="margin-left:10px;">
					<input type="checkbox" name="is_favorite"> Favorite
				</label>
				<br>
				<button type="submit">‚ûï Add Poem</button>
			</form>
		</div>

		<div class="section">
			<h2>üíå Send a Temporary Message</h2>
			<form action="/poem_override" method="POST">
				<input type="text" name="override_msg" placeholder="This message will replace poems temporarily">
				<button type="submit">üì§ Send Message</button>
			</form>
			<p><strong>Current Override:</strong> {{ override or "None" }}</p>
			<form action="/clear_override" method="POST">
				<button class="small-button" type="submit">‚ùå Clear override</button>
			</form>
		</div>

		<div class="section">
			<h2>üìú Current Poem</h2>
			<div id="current-poem" style="white-space: pre-wrap; border-color: #333;">
				<div id="poemText">Loading...</div>
				<div id="poemAuthor" style="margin-top: 4px; font-style: italic;"></div>
			</div>

			<div style="margin-top: 10px;">
				<form id="favForm" method="POST" style="display:inline;">
					<button type="submit" class="small-button" title="Favorite">‚ù§</button>
				</form>

				<form id="removeForm" method="POST" style="display:inline;">
					<button type="submit" class="small-button" title="Remove">‚úñ</button>
				</form>
			</div>

		<script>
			// Get the live public base (ngrok) from the server (works on Render)
			async function getBase() {
				try {
					const res = await fetch('/ngrok', { redirect: 'follow' });
					if (!res.ok) throw new Error('status ' + res.status);
					const data = await res.json();
					if (data && data.base) return String(data.base).replace(/\/+$/, '');
				} catch (e) {
					console.warn('Falling back to current origin:', e);
				}
				return window.location.origin.replace(/\/+$/, '');
			}
		
			let BASE = null;

			// Point the forms at the live base (no hard-coding)
			function wireForms() {
				const fav = document.getElementById('favForm');
				const rem = document.getElementById('removeForm');
				const add = document.getElementById('addForm');
				if (fav) fav.action = `${BASE}/favorite_poem`;
				if (rem) rem.action = `${BASE}/remove_poem`;
				if (add) add.action = `${BASE}/add_poem`;
			}

			// Load the current poem from the live base
			async function updateCurrentPoem() {
				try {
					const res = await fetch(`${BASE}/current_poem`, { method: 'GET' });
					if (!res.ok) throw new Error('status ' + res.status);
					const data = await res.json();
					document.getElementById('poemText').textContent = data.text || '‚Äî';
					document.getElementById('poemAuthor').textContent = data.author || '';
				} catch (err) {
					console.error('Fetch error:', err);
					document.getElementById('poemText').textContent = 'Error loading poem';
					document.getElementById('poemAuthor').textContent = '';
				}
			}

			// Init on page load: get base, wire forms, load & refresh poem
			(async function init() {
				BASE = await getBase(); // e.g. https://<current>.ngrok-free.app
				wireForms();
				updateCurrentPoem();
				setInterval(updateCurrentPoem, 5000);
			})();
		</script>

		</div>
	</div>
</body>
</html>
