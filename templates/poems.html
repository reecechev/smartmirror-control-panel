<!DOCTYPE html>
<html>
<head>
	<title>Poem Manager</title>
	<style>
		body {
			background-color: #111;
			color: #fff;
			font-family: sans-serif;
			padding: 20px;
		}

		h2 {
			margin-top: 40px;
			font-size: 1.4em;
			border-bottom: 1px solid #333;
			padding-bottom: 5px;
		}
		
		.section {
			background-color: #1e1e1e;
			padding: 15px;
			border-radius: 10px;
			margin-bottom: 25px;
			box-shadow: 0 0 8px rgba(255,255,255,0.05);
		}
	
		input, textarea {
			width: 100%;
			padding: 10px;
			margin-top: 5px;
			margin-bottom: 10px;
			border: none;
			border-radius: 5px;
			background-color: #2c2c2c;
			color: #fff;
		}
		
		button {
			background-color: #007bff;
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.9em;
		}

		.small-button {
			background-color: #444;
			font-size: 0.8em;
			margin-top: 5px;
		}
	</style>
</head>
<body>

	<h1 style="text-align: center;">ü™û Poem Manager</h1>

	<div class="section">
		<h2>‚ûï Add a New Poem</h2>
		<form id="addForm" method="POST">
			<textarea name="poem_text" rows="4" placeholder="Write a new poem‚Ä¶" required></textarea>
			<br>
			<input type="text" name="author" placeholder="Author (optional)">
			<label style="margin-left:10px;">
				<input type="checkbox" name="is_favorite"> Favorite
			</label>
			<br>
			<button type="submit">‚ûï Add Poem</button>
		</form>
	</div>

	<div class="section">
		<h2>üíå Send a Temporary Message</h2>
		<form action="/poem_override" method="POST">
			<input type="text" name="override_msg" placeholder="This message will replace poems temporarily">
			<button type="submit">üì§ Send Message</button>
		</form>
		<p><strong>Current Override:</strong> {{ override or "None" }}</p>
		<form action="/clear_override" method="POST">
			<button class="small-button" type="submit">‚ùå Clear override</button>
		</form>
	</div>

	<div class="section">
		<h2>üìú Current Poem</h2>
		<div id="current-poem" style="white-space: pre-wrap; border-color: #333;">
			<div id="poemText">Loading...</div>
			<div id="poemAuthor" style="margin-top: 4px; font-style: italic;"></div>
		</div>

		<div style="margin-top: 10px;">
			<form id="favForm" method="POST" style="display:inline;">
				<button type="submit" class="small-button" title="Favorite">‚ù§</button>
			</form>

			<form id="removeForm" method="POST" style="display:inline;">
				<button type="submit" class="small-button" title="Remove">‚úñ</button>
			</form>
		</div>

	<script>
		// Get the live public base (ngrok) from the server (works on Render)
		async function getBase() {
			try {
				const res = await fetch('/ngrok', { redirect: 'follow' });
				if (!res.ok) throw new Error('status ' + res.status);
				const data = await res.json();
				if (data && data.base) return String(data.base).replace(/\/+$/, '');
			} catch (e) {
				console.warn('Falling back to current origin:', e);
			}
			return window.location.origin.replace(/\/+$/, '');
		}
	
		let BASE = null;

		// Point the forms at the live base (no hard-coding)
		function wireForms() {
			const fav = document.getElementById('favForm');
			const rem = document.getElementById('removeForm');
			const add = document.getElementById('addForm');
			if (fav) fav.action = `${BASE}/favorite_poem`;
			if (rem) rem.action = `${BASE}/remove_poem`;
			if (add) add.action = `${BASE}/add_poem`;
		}

		// Load the current poem from the live base
		async function updateCurrentPoem() {
			try {
				const res = await fetch(`${BASE}/current_poem`, { method: 'GET' });
				if (!res.ok) throw new Error('status ' + res.status);
				const data = await res.json();
				document.getElementById('poemText').textContent = data.text || '‚Äî';
				document.getElementById('poemAuthor').textContent = data.author || '';
			} catch (err) {
				console.error('Fetch error:', err);
				document.getElementById('poemText').textContent = 'Error loading poem';
				document.getElementById('poemAuthor').textContent = '';
			}
		}

		// Init on page load: get base, wire forms, load & refresh poem
		(async function init() {
			BASE = await getBase(); // e.g. https://<current>.ngrok-free.app
			wireForms();
			updateCurrentPoem();
			setInterval(updateCurrentPoem, 5000);
		})();
	</script>

	</div>

</body>
</html>
