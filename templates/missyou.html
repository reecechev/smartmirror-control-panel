<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>I Miss You</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<style>
		body {
			background-color: #121212;
			color: #ffffff;
			font-family: 'Segoe UI', sans-serif;
		}

		.heart-ring {
			position: relative;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			fill: none;
			stroke: red;
			stroke-width: 2px;
			opacity: 0.5;
			pointer-events: none;
			animation: fadeout 30s linear forwards;
		}
		
		@keyframes fadeout {
			0% { opacity: 0.5; }
			100% { opacity: 0; }
		}

		#heartContainer {
			position: relative;
			width: 150px;
			height: 150px;
			margin: 20px auto;
		}

		#heartButton {
			width: 60px;
			height: 60px;
			background-color: red;
			clip-path: path("M30 0 C80 0, 80 60, 30 90 C-20 60, -20 0, 30 0 Z");
			position: absolute;
			top: 45px;
			left: 45px;
			cursor: pointer;
		}

		.section-title {
			margin-top: 30px;
			margin-bottom: 10px;
			font-weight: bold;
		}
	</style>
</head>
<body style="background-color: #121212; color: white; font-family: Arial, sans-serif;">
	<div style="text-align: center; padding: 20px;">
		<h2 style="color: white;">❤️ I Miss You</h2>

		<!-- Override Toggle -->
		<label style="display: block; margin: 10px auto;">
			<input type="checkbox" id="overrideToggle" onchange="toggleOverride()" />
			<span style="margin-left: 8px;">Use Override Messages</span>
		</label>

		<!-- Heart Container -->
		<div id="heart-container" style="position: relative; width: 150px; height: 150px; margin: 20px auto;">
			<!-- Main Clickable Heart -->
			<div id="sendHeart" onclick="sendHeart()" style="
				font-size: 60px;
				cursor: pointer;
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				z-index: 10;">
				❤️
			</div>
		</div>

		<!-- Hearts Sent Counter -->
		<div style="margin-top: 10px; text-align: center;">
			❤️ Hearts Sent: <span id="heartCount">0</span>
		</div>
	</div>

	<script>
		// --- persistent counters (survive reloads in your own browser) ---
		let clickCount = localStorage.getItem("clickCount")
			? parseInt(localStorage.getItem("clickCount"))
			: 0;

		let heartCount = localStorage.getItem("heartCount")
			? parseInt(localStorage.getItem("heartCount"))
			: 0;

		// show current heart count in the UI, if you have <span id="heartCount">
		const hcEl = document.getElementById("heartCount");
		if (hcEl) hcEl.innerText = heartCount;

		function sendHeart() {
			// 1) increment locally on EVERY tap
			clickCount += 1;
			localStorage.setItem("clickCount", clickCount);

			// 2) every 10 taps, add a visible heart layer in the page
			if (clickCount % 10 === 0) {
				heartCount += 1;
				if (hcEl) hcEl.innerText = heartCount;
				localStorage.setItem("heartCount", heartCount);
				addHeartLayer(heartCount);
			}

			// 3) ALWAYS notify the server on EVERY tap (this is what the mirror reads)
			fetch('/missyou/tap', { method: 'POST' })
			.then(res => {
				if (!res.ok) throw new Error('server response not ok');
				return res.json().catch(() => ({}));
			})
			.then(data => {
				// optional: you can reconcile with server here if you want later
				console.log('[tap] sent OK');
			})
			.catch(err => {
				console.error('Network/server error', err);
			});
		}
	<script>
		// --- get live API base from the server (no hard-coding) ---
		async function getBase() {
			try {
				// Works on Render too (handles its redirect automatically)
				const res = await fetch('/ngrok', { redirect: 'follow' });
				if (!res.ok) throw new Error('bad status');
				const data = await res.json();
				if (data && data.base) return String(data.base).replace(/\/+$/, '');
			} catch (e) {
				console.warn('Falling back to current origin for API base:', e);
			}
			// Fallback to the same origin if /ngrok is unreachable
			return window.location.origin.replace(/\/+$/, '');
		}

		// unified helper to call the API with the resolved base
		let BASE = null;
		function api(path, options) {
			const p = path.startsWith('/') ? path : `/${path}`;
			return fetch(`${BASE}${p}`, options);
		}

		// --- persistent counters (in your own browser only) ---
		let clickCount = localStorage.getItem("clickCount")
			? parseInt(localStorage.getItem("clickCount"))
			: 0;

		let heartCount = localStorage.getItem("heartCount")
			? parseInt(localStorage.getItem("heartCount"))
			: 0;

		const hcEl = document.getElementById("heartCount");
		if (hcEl) hcEl.innerText = heartCount;

		// initialize BASE once the page loads
		(async function init() {
			BASE = await getBase();
			console.log('API base:', BASE);
		})();

		// --- tap handler: ALWAYS POST; add a visual heart every 10 taps ---
		function sendHeart() {
			// 1) local click counter
			clickCount += 1;
			localStorage.setItem("clickCount", clickCount);

			// 2) visual heart every 10 taps
			if (clickCount % 10 === 0) {
				heartCount += 1;
				if (hcEl) hcEl.innerText = heartCount;
				localStorage.setItem("heartCount", heartCount);
				addHeartLayer(heartCount);
			}

			// 3) notify server on EVERY tap (mirror reads from here)
			api('/missyou/tap', { method: 'POST' })
				.then(res => {
					if (!res.ok) throw new Error('server not ok');
					return res.json().catch(() => ({}));
				})
				.catch(err => console.error('Network/server error', err));
		}

		function addHeartLayer(ringNum) {
			const ring = document.createElement('div');
			const size = 60 + ringNum * 10; // each layer grows a bit
			ring.innerText = "❤";
			ring.style.fontSize = `${size}px`;
			ring.style.opacity = '0.35';
			ring.style.position = 'absolute';
			ring.style.top = '50%';
			ring.style.left = '50%';
			ring.style.transform = 'translate(-50%, -50%)';
			ring.style.pointerEvents = 'none';
			ring.style.zIndex = 5;
			ring.className = 'heart-ring';

			document.getElementById('heart-container').appendChild(ring);

			// Auto-remove after 30 minutes (matches mirror expiry)
			setTimeout(() => {
				try { ring.remove(); } catch(e) {}
			}, 1800000);
		}
	</script>

</body>
</html>
